<!DOCTYPE html>
<html>

<head>
    <title>프라시아 보스탐</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VCLM0CTXBB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-VCLM0CTXBB');
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-qKXV1j0HvMUeCBQ+QVp7JcfGl760yU08IQ+GpUo5hlbpg51QRiuqHAJz8+BrxE/N"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1338813848148433"
        crossorigin="anonymous"></script>
    <style>
        .component-container {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        ul {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            /* 2개의 동일한 폭으로 그리드 형태로 배치 */
            grid-gap: 10px;
            /* 요소들 사이의 간격 */
        }

        li {
            list-style: none;
            /* 리스트 마커 제거 */
        }
    </style>
</head>

<body style="width: 800px;">
    <div style="float: right;">
        <button id="export-btn" class="btn btn-secondary">보스정보 추출</button>
        <button id="import-btn" class="btn btn-secondary">보스정보 넣기</button>
        <button id="share-link-btn" class="btn btn-secondary">링크복사(정보포함)</button>
        <input type="file" id="import-input" style="display: none">
    </div>
    <!-- <form> -->
    <div>
        <div class="component-container">
            <label for="hour-select">시</label>
            <select class="form-select" id="hour-select"></select>
        </div>
        <div class="component-container">
            <label for="minute-select">분</label>
            <select class="form-select" id="minute-select"></select>
        </div>
        <div class="component-container">
            <button id="setCurTime" class="btn btn-primary">지금시간으로 넣기</button>
        </div>
    </div>
    <div>
        <label for="name-input">등장위치:</label>
        <input type="text" id="name-input">
        <button type="button" id="save-btn" class="btn btn-success">저장</button>
    </div>
    <!-- </form> -->
    <span id="infospan"></span>
    <ul id="boss-list" class="list-inline">
    </ul>

    <script>



        // hour options 생성
        var hourSelect = document.getElementById("hour-select");
        for (var i = 0; i < 24; i++) {
            var option = document.createElement("option");
            option.value = i;
            option.text = i;
            hourSelect.add(option);
        }
        // minute options 생성
        var minuteSelect = document.getElementById("minute-select");
        for (var i = 0; i < 60; i++) {
            var option = document.createElement("option");
            option.value = i;
            option.text = i;
            minuteSelect.add(option);
        }

        // 저장 버튼 클릭 시 이벤트 핸들러
        var saveBtn = document.getElementById("save-btn");
        let bossList = [];
        saveBtn.addEventListener("click", function () {
            var hour = hourSelect.value;
            var minute = minuteSelect.value;
            var name = document.getElementById("name-input").value;

            if (!name) {
                document.getElementById("infospan").innerText = "이름을 입력하세요";
            } else {
                const day = dayjs();
                var timeForAdd = day.set('hour', hour).set('minute', minute);
                bossList.push({ hour: parseInt(timeForAdd.add(3, 'hour').format('HH')), minute: parseInt(timeForAdd.format('mm')), name: name });
                document.getElementById("infospan").innerText = "";
                document.getElementById("name-input").value = "";
                renderBossList();

            }
        });

        var setTimeBtn = document.getElementById("setCurTime");
        setTimeBtn.addEventListener("click", function () {
            var currentDate = new Date();
            var currentHour = currentDate.getHours();
            var currentMinute = currentDate.getMinutes();
            document.getElementById("hour-select").value = currentHour;
            document.getElementById("minute-select").value = currentMinute;
        })

        // bossList 렌더링
        var bossListEl = document.getElementById("boss-list");
        function renderBossList() {
            // 기존 목록 삭제
            bossListEl.innerHTML = "";
            // 시간순으로 정렬
            bossList.sort(function (a, b) {
                var aTime = new Date();
                aTime.setHours(a.hour, a.minute, 0, 0);
                var bTime = new Date();
                bTime.setHours(b.hour, b.minute, 0, 0);
                return aTime - bTime;
            });
            // 새로운 목록 렌더링
            bossList.forEach(function (boss, index) {
                var li = document.createElement("li");
                li.className = "list-inline-item col";

                var liDiv = document.createElement("div");
                liDiv.style.display = "inline-block";
                liDiv.style.padding = "10px";

                var liTime = document.createElement("span");
                liTime.style.display = "inline-block";
                liTime.style.width = "100px";
                liTime.textContent = boss.hour + "시 " + boss.minute + "분 ";

                var liBossName = document.createElement("span");
                liBossName.style.display = "inline-block";
                liBossName.style.width = "200px";
                liBossName.textContent = boss.name;

                var addOneMinute = document.createElement("button");
                addOneMinute.textContent = "+1분";
                addOneMinute.className = "btn btn-secondary"
                addOneMinute.style.marginRight = "5px"
                addOneMinute.addEventListener("click", function () {
                    const now = dayjs();
                    var customTime = now.set('hour', parseInt(boss.hour)).set('minute', parseInt(boss.minute));
                    var caclTime = customTime.add(1, 'minute');

                    var newData = { ...boss };
                    newData.hour = parseInt(caclTime.format('HH'));
                    newData.minute = parseInt(caclTime.format('mm'));

                    bossList[index] = newData;

                    renderBossList();
                });

                var minusOneMinute = document.createElement("button");
                minusOneMinute.textContent = "-1분";
                minusOneMinute.className = "btn btn-secondary"
                minusOneMinute.style.marginRight = "5px"
                minusOneMinute.addEventListener("click", function () {
                    const now = dayjs();
                    var customTime = now.set('hour', parseInt(boss.hour)).set('minute', parseInt(boss.minute));
                    var caclTime = customTime.subtract(1, 'minute');

                    var newData = { ...boss };
                    newData.hour = parseInt(caclTime.format('HH'));
                    newData.minute = parseInt(caclTime.format('mm'));

                    bossList[index] = newData;

                    renderBossList();
                });

                var deleteBtn = document.createElement("button");
                deleteBtn.textContent = "삭제";
                deleteBtn.className = "btn btn-dark"

                deleteBtn.addEventListener("click", function () {
                    bossList.splice(index, 1);
                    localStorage.setItem("bosslist", JSON.stringify(bossList));
                    renderBossList();
                });

                var killBtn = document.createElement("button");
                killBtn.textContent = "보스잡힘";
                killBtn.className = "btn btn-danger"
                killBtn.style.marginRight = "5px"
                killBtn.addEventListener("click", function () {
                    bossList[index].hour = plusThreeTime(boss.hour, boss.minute).hour;
                    bossList[index].minute = plusThreeTime(boss.hour, boss.minute).minute;
                    renderBossList();
                })

                var timeLabel = document.createElement("span");
                timeLabel.style.display = "inline-block";
                timeLabel.style.width = "180px";
                var now = new Date();
                var bossTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), boss.hour, boss.minute);
                var timeDiff = bossTime - now;
                var rest = Math.floor((timeDiff / 1000 / 60) + 1);

                if (timeDiff <= 10 * 60 * 1000 && timeDiff > 0) {
                    liDiv.style.backgroundImage = getNumberColor(rest);
                    timeLabel.textContent = timeDiff < 5 * 1000 ? " 곧 나옵니다!!" : ` ${rest === 0 ? '출현' : rest}분 남음`;
                }
                else if (timeDiff < 0) {
                    var diffMinutes = Math.floor((-timeDiff) / 1000 / 60);
                    if (diffMinutes < 10) {
                        liDiv.style.backgroundImage = getNumberColor(1, 'gray');
                        timeLabel.textContent = `${diffMinutes} 분 지남`;
                    }
                    //  else {
                    //     bossList[index].hour = getNow().hour
                    //     bossList[index].minute = getNow().minute
                    // }
                }
                liDiv.appendChild(liTime);
                liDiv.appendChild(liBossName);
                liDiv.appendChild(timeLabel);
                li.appendChild(liDiv);
                li.appendChild(addOneMinute);
                li.appendChild(minusOneMinute);
                li.appendChild(killBtn);
                li.appendChild(deleteBtn);
                li.style.backgroundColor = "null";
                bossListEl.appendChild(li);
            });
        }

        function getFileName() {
            var now = new Date();
            var fileName = now.getFullYear() +
                ("0" + (now.getMonth() + 1)).slice(-2) +
                ("0" + now.getDate()).slice(-2) + "_" +
                "mercenary.json";
            return fileName;
        }

        // export 버튼 클릭 이벤트 핸들러
        var exportBtn = document.getElementById("export-btn");
        exportBtn.addEventListener("click", function () {
            // bossList를 json 문자열로 변환
            var dataStr = JSON.stringify(bossList);
            // 파일 다운로드
            var fileName = getFileName();
            var link = document.createElement("a");
            link.download = fileName;
            link.href = "data:text/plain;charset=utf-8," + encodeURIComponent(dataStr);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // import 버튼 클릭 이벤트 핸들러
        var importBtn = document.getElementById("import-btn");
        var importInput = document.getElementById("import-input");
        importBtn.addEventListener("click", function () {
            importInput.click();
        });
        importInput.addEventListener("change", function () {
            var files = importInput.files;
            if (files.length <= 0) {
                return;
            }
            var fileName = files[0].name;
            if (!fileName.includes("mercenary")) {
                return;
            }
            var fr = new FileReader();
            fr.onload = function () {
                var importedData = [];
                bossList = JSON.parse(importedData);
                renderBossList();
            }
            fr.readAsText(files.item(0));
            importInput.value = '';
        });

        const shareLinkBtn = document.getElementById('share-link-btn');
        shareLinkBtn.addEventListener('click', function () {
            if (bossList.length > 0) {
                const query = new URLSearchParams({ bosslist: JSON.stringify(bossList) });
                const url = `${window.location.href.split('?')[0]}?${query.toString()}`;

                // Example usage:
                shortenUrl(url)
                    .then(shortUrl => {

                        console.log('Shortened URL:', shortUrl)

                        navigator.clipboard.writeText(shortUrl)
                            .then(() => {
                                document.getElementById('share-link-btn').textContent = "복사완료";
                            })
                            .catch(error => console.error('Failed to copy to clipboard:', error));


                    })
                    .catch(error => console.error(error));


            } else {

            }
        });

        function getNumberColor(number, color) {
            var color = color || "red";
            var intensity = (10 - number) * 10; // 1이면 90%, 10이면 0% 진한 빨간색
            var bg = "linear-gradient(to right, " + color + " " + intensity + "%, transparent " + intensity + "%)";
            return bg;
        }



        // interval로 bossList 검사
        setInterval(function () {
            renderBossList();
        }, 1000);

        window.addEventListener("beforeunload", function (event) {
            if (bossList.length > 0) {
                if (typeof bossList === 'object') {
                    localStorage.setItem("bosslist", JSON.stringify(bossList));
                }
            }
        });

        window.addEventListener("load", function () {

            const query = new URLSearchParams(window.location.search);

            const getParamBossList = query.get('bosslist');

            //링크로 접근
            if (getParamBossList && getParamBossList.length > 0) {
                localStorage.setItem("bosslist", getParamBossList);
                const url = window.location.pathname;
                window.location.replace(url);
            }

            // 이전에 작성한 bossList를 불러옴
            var storedData = localStorage.getItem("bosslist");
            if (storedData) {
                bossList = JSON.parse(storedData);
                renderBossList();
            }

        });


        const getNow = () => {
            let now = dayjs();
            let afterThree = now.add(3, 'hour');
            return { hour: parseInt(afterThree.format('HH')), minute: parseInt(afterThree.format('mm')) }
        }

        const plusThreeTime = (hour, minute) => {
            let now = dayjs();
            let afterThree = now.set('hour', hour).set('minute', minute).add(3, 'hour');
            return { hour: parseInt(afterThree.format('HH')), minute: parseInt(afterThree.format('mm')) }
        }

        function shortenUrl(url) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const apiUrl = 'https://cleanuri.com/api/v1/shorten?url=' + encodeURIComponent(url);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);
                            if (data.result_url) {
                                resolve(data.result_url);
                            } else {
                                reject(new Error('Failed to shorten URL: ' + data.error));
                            }
                        } else {
                            reject(new Error('Failed to make API request. Status code: ' + xhr.status));
                        }
                    }
                };

                xhr.open('GET', apiUrl);
                xhr.send();
            });
        }



    </script>
</body>

</html>